<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panigal</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cae;
            --light-color: #f0f4f8;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --border-color: #ddd;
            --sidebar-width: 250px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
            display: flex;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background-color: white;
            height: 100vh;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            height: 100vh;
            box-sizing: border-box;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .associate-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-left: 3px solid transparent;
        }
        
        .associate-item:hover {
            background-color: var(--light-color);
        }
        
        .associate-item.active {
            background-color: var(--light-color);
            border-left: 3px solid var(--primary-color);
        }
        
        .associate-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .associate-stats {
            display: flex;
            font-size: 12px;
            color: #666;
        }
        
        .associate-stat {
            margin-right: 15px;
            display: flex;
            align-items: center;
        }
        
        .stat-count {
            font-weight: bold;
            margin-left: 5px;
        }
        
        .todo-count {
            color: var(--warning-color);
        }
        
        .ongoing-count {
            color: var(--primary-color);
        }
        
        .done-count {
            color: var(--success-color);
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .associate-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        button {
            padding: 8px 12px;
            border-radius: 4px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .primary-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .primary-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .danger-btn {
            background-color: var(--danger-color);
            color: white;
        }
        
        .danger-btn:hover {
            background-color: #d32f2f;
        }
        
        .success-btn {
            background-color: var(--success-color);
            color: white;
        }
        
        .success-btn:hover {
            background-color: #388e3c;
        }
        
        .info-btn {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .info-btn:hover {
            background-color: #5a7b9d;
        }
        
        .task-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-column {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-title {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            color: var(--primary-color);
        }
        
        .todo .status-title {
            color: #666;
        }
        
        .ongoing .status-title {
            color: var(--warning-color);
        }
        
        .done .status-title {
            color: var(--success-color);
        }
        
        .task-list {
            min-height: 100px;
            padding: 10px;
            background-color: var(--light-color);
            border-radius: 6px;
        }
        
        .task-card {
            background-color: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: move;
            position: relative;
        }
        
        .task-card:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .task-title {
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .task-dates {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .task-date {
            font-size: 12px;
            color: #666;
        }
        
        .task-date-label {
            font-weight: 600;
            color: #444;
        }
        
        .task-notes {
            font-size: 13px;
            color: #555;
            margin-bottom: 8px;
            white-space: pre-wrap;
        }
        
        .task-actions {
            display: flex;
            justify-content: flex-end;
            gap: 5px;
        }
        
        .task-actions button {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .overdue {
            color: var(--danger-color) !important;
            font-weight: bold;
        }
        
        .today {
            color: var(--warning-color) !important;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
            }
            
            .main-content {
                height: auto;
            }
            
            .task-board {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div id="associatesList"></div>
        <button id="addAssociateBtn" class="primary-btn" style="margin-top: 20px; width: 100%;">Add Associate</button>
    </div>
    
    <div class="main-content">
        <div class="container">
            
            <div class="controls">
                <div class="associate-actions">
                    <button id="editAssociateBtn" class="primary-btn" disabled>Edit Associate</button>
                    <button id="deleteAssociateBtn" class="danger-btn" disabled>Delete Associate</button>
                </div>
                <div>
                    <button id="addTaskBtn" class="primary-btn" disabled>Add Task</button>
                    <button id="exportBtn" class="info-btn">Export Data</button>
                    <button id="exportDoneBtn" class="success-btn">Export Done Tasks</button>
                    <button id="importBtn" class="info-btn">Import Data</button>
                    <input type="file" id="fileInput" style="display: none;" accept=".json">
                </div>
            </div>
            
            <div class="task-board">
                <div class="status-column todo">
                    <div class="status-title">To Do</div>
                    <div class="task-list" data-status="todo" id="todoList"></div>
                </div>
                <div class="status-column ongoing">
                    <div class="status-title">Ongoing</div>
                    <div class="task-list" data-status="ongoing" id="ongoingList"></div>
                </div>
                <div class="status-column done">
                    <div class="status-title">Done</div>
                    <div class="task-list" data-status="done" id="doneList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Task Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-title" id="taskModalTitle">Add New Task</div>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <div class="form-group">
                    <label for="taskTitle">Title</label>
                    <input type="text" id="taskTitle" required>
                </div>
                <div class="form-group">
                    <label for="taskDueDate">Due Date</label>
                    <input type="date" id="taskDueDate">
                </div>
                <div class="form-group">
                    <label for="taskStatus">Status</label>
                    <select id="taskStatus">
                        <option value="todo">To Do</option>
                        <option value="ongoing">Ongoing</option>
                        <option value="done">Done</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskNotes">Notes</label>
                    <textarea id="taskNotes"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancelTaskBtn" class="danger-btn">Cancel</button>
                    <button type="submit" id="saveTaskBtn" class="primary-btn">Save Task</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Reassign Modal -->
    <div class="modal" id="reassignModal">
        <div class="modal-content">
            <div class="modal-title">Reassign Task</div>
            <form id="reassignForm">
                <input type="hidden" id="reassignTaskId">
                <div class="form-group">
                    <label for="reassignAssociate">Assign to</label>
                    <select id="reassignAssociate" required>
                        <option value="">Select an associate</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancelReassignBtn" class="danger-btn">Cancel</button>
                    <button type="submit" class="info-btn">Reassign Task</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Associate Modal -->
    <div class="modal" id="associateModal">
        <div class="modal-content">
            <div class="modal-title" id="associateModalTitle">Add New Associate</div>
            <form id="associateForm">
                <input type="hidden" id="associateId">
                <div class="form-group">
                    <label for="associateName">Name</label>
                    <input type="text" id="associateName" required>
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancelAssociateBtn" class="danger-btn">Cancel</button>
                    <button type="submit" id="saveAssociateBtn" class="primary-btn">Save Associate</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data structure
        let appData = {
            associates: [],
            tasks: []
        };
        
        // DOM elements
        const sidebar = document.getElementById('sidebar');
        const associatesList = document.getElementById('associatesList');
        const addAssociateBtn = document.getElementById('addAssociateBtn');
        const editAssociateBtn = document.getElementById('editAssociateBtn');
        const deleteAssociateBtn = document.getElementById('deleteAssociateBtn');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const exportBtn = document.getElementById('exportBtn');
        const exportDoneBtn = document.getElementById('exportDoneBtn');
        const importBtn = document.getElementById('importBtn');
        const fileInput = document.getElementById('fileInput');
        
        const todoList = document.getElementById('todoList');
        const ongoingList = document.getElementById('ongoingList');
        const doneList = document.getElementById('doneList');
        
        const taskModal = document.getElementById('taskModal');
        const taskModalTitle = document.getElementById('taskModalTitle');
        const taskForm = document.getElementById('taskForm');
        const taskIdInput = document.getElementById('taskId');
        const taskTitleInput = document.getElementById('taskTitle');
        const taskDueDateInput = document.getElementById('taskDueDate');
        const taskStatusInput = document.getElementById('taskStatus');
        const taskNotesInput = document.getElementById('taskNotes');
        const cancelTaskBtn = document.getElementById('cancelTaskBtn');
        const saveTaskBtn = document.getElementById('saveTaskBtn');
        
        const reassignModal = document.getElementById('reassignModal');
        const reassignForm = document.getElementById('reassignForm');
        const reassignTaskIdInput = document.getElementById('reassignTaskId');
        const reassignAssociateInput = document.getElementById('reassignAssociate');
        const cancelReassignBtn = document.getElementById('cancelReassignBtn');
        
        const associateModal = document.getElementById('associateModal');
        const associateModalTitle = document.getElementById('associateModalTitle');
        const associateForm = document.getElementById('associateForm');
        const associateIdInput = document.getElementById('associateId');
        const associateNameInput = document.getElementById('associateName');
        const cancelAssociateBtn = document.getElementById('cancelAssociateBtn');
        const saveAssociateBtn = document.getElementById('saveAssociateBtn');
        
        // Current state
        let currentAssociateId = null;
        let isEditingTask = false;
        let isEditingAssociate = false;
        
        // Initialize the app
        function init() {
            loadData();
            setupEventListeners();
            renderAssociates();
            updateUI();
        }
        
        // Load data from localStorage
        function loadData() {
            const savedData = localStorage.getItem('taskTrackerData');
            if (savedData) {
                appData = JSON.parse(savedData);
                
                // Migrate old data to include createdDate and completedDate
                appData.tasks = appData.tasks.map(task => {
                    if (!task.createdDate) {
                        task.createdDate = new Date().toISOString().split('T')[0];
                    }
                    if (task.status === 'done' && !task.completedDate) {
                        task.completedDate = new Date().toISOString().split('T')[0];
                    }
                    return task;
                });
                
                saveData();
            } else {
                // Sample data for demo
                const today = new Date().toISOString().split('T')[0];
                appData = {
                    associates: [
                        { id: '1', name: 'John Doe' },
                        { id: '2', name: 'Jane Smith' },
                        { id: '3', name: 'Mike Johnson' }
                    ],
                    tasks: [
                        { 
                            id: '1', 
                            associateId: '1', 
                            title: 'Complete project proposal', 
                            dueDate: '2023-12-15', 
                            status: 'todo', 
                            notes: 'Need to include budget estimates',
                            createdDate: today,
                            order: 0
                        },
                        { 
                            id: '2', 
                            associateId: '1', 
                            title: 'Client meeting prep', 
                            dueDate: '2023-12-10', 
                            status: 'ongoing', 
                            notes: 'Prepare slides and demo',
                            createdDate: today,
                            order: 0
                        },
                        { 
                            id: '3', 
                            associateId: '2', 
                            title: 'Review code changes', 
                            dueDate: '2023-12-08', 
                            status: 'done', 
                            notes: 'All tests passed',
                            createdDate: today,
                            completedDate: today,
                            order: 0
                        }
                    ]
                };
                saveData();
            }
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('taskTrackerData', JSON.stringify(appData));
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Associate buttons
            addAssociateBtn.addEventListener('click', () => {
                isEditingAssociate = false;
                associateModalTitle.textContent = 'Add New Associate';
                associateForm.reset();
                associateIdInput.value = '';
                associateModal.style.display = 'flex';
            });
            
            editAssociateBtn.addEventListener('click', () => {
                if (!currentAssociateId) return;
                
                isEditingAssociate = true;
                associateModalTitle.textContent = 'Edit Associate';
                const associate = appData.associates.find(a => a.id === currentAssociateId);
                if (associate) {
                    associateIdInput.value = associate.id;
                    associateNameInput.value = associate.name;
                    associateModal.style.display = 'flex';
                }
            });
            
            deleteAssociateBtn.addEventListener('click', () => {
                if (!currentAssociateId) return;
                
                if (confirm('Are you sure you want to delete this associate and all their tasks?')) {
                    // Delete associate
                    appData.associates = appData.associates.filter(a => a.id !== currentAssociateId);
                    
                    // Delete associated tasks
                    appData.tasks = appData.tasks.filter(t => t.associateId !== currentAssociateId);
                    
                    saveData();
                    currentAssociateId = null;
                    renderAssociates();
                    renderTasks();
                    updateUI();
                }
            });
            
            // Task buttons
            addTaskBtn.addEventListener('click', () => {
                if (!currentAssociateId) return;
                
                isEditingTask = false;
                taskModalTitle.textContent = 'Add New Task';
                taskForm.reset();
                taskIdInput.value = '';
                taskStatusInput.value = 'todo';
                
                // Set default due date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                taskDueDateInput.valueAsDate = tomorrow;
                
                taskModal.style.display = 'flex';
            });
            
            // Export/import
            exportBtn.addEventListener('click', exportData);
            exportDoneBtn.addEventListener('click', exportDoneTasks);
            importBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', importData);
            
            // Modal buttons
            cancelTaskBtn.addEventListener('click', () => {
                taskModal.style.display = 'none';
            });
            
            cancelReassignBtn.addEventListener('click', () => {
                reassignModal.style.display = 'none';
            });
            
            cancelAssociateBtn.addEventListener('click', () => {
                associateModal.style.display = 'none';
            });
            
            // Forms
            taskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveTask();
            });
            
            reassignForm.addEventListener('submit', (e) => {
                e.preventDefault();
                reassignTask();
            });
            
            associateForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveAssociate();
            });
            
            // Make task lists sortable
            makeSortable(todoList);
            makeSortable(ongoingList);
            makeSortable(doneList);
        }
        
        // Make a list sortable with drag and drop
        function makeSortable(listElement) {
            listElement.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(listElement, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) {
                    listElement.appendChild(draggable);
                } else {
                    listElement.insertBefore(draggable, afterElement);
                }
            });
            
            // Update task order when drag ends
            listElement.addEventListener('dragend', () => {
                const taskElements = listElement.querySelectorAll('.task-card');
                const status = listElement.dataset.status;
                
                taskElements.forEach((el, index) => {
                    const taskId = el.dataset.taskId;
                    const task = appData.tasks.find(t => t.id === taskId);
                    if (task) {
                        // If task was moved to done, set completed date
                        if (status === 'done' && task.status !== 'done') {
                            task.completedDate = new Date().toISOString().split('T')[0];
                        }
                        task.status = status;
                        task.order = index;
                    }
                });
                
                saveData();
                renderAssociates();
                renderTasks();
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // Render associates in the sidebar
        function renderAssociates() {
            associatesList.innerHTML = '';
            
            if (appData.associates.length === 0) {
                associatesList.innerHTML = '<div class="empty-state">No associates found</div>';
                return;
            }
            
            appData.associates.forEach(associate => {
                const associateItem = document.createElement('div');
                associateItem.className = `associate-item ${associate.id === currentAssociateId ? 'active' : ''}`;
                associateItem.dataset.associateId = associate.id;
                
                // Count tasks for this associate
                const tasks = appData.tasks.filter(task => task.associateId === associate.id);
                const todoCount = tasks.filter(t => t.status === 'todo').length;
                const ongoingCount = tasks.filter(t => t.status === 'ongoing').length;
                const doneCount = tasks.filter(t => t.status === 'done').length;
                
                associateItem.innerHTML = `
                    <div class="associate-name">${associate.name}</div>
                    <div class="associate-stats">
                        <div class="associate-stat todo-count">To Do: <span class="stat-count">${todoCount}</span></div>
                        <div class="associate-stat ongoing-count">In Progress: <span class="stat-count">${ongoingCount}</span></div>
                    </div>
                `;
                
                associateItem.addEventListener('click', () => {
                    currentAssociateId = associate.id;
                    renderAssociates();
                    renderTasks();
                    updateUI();
                });
                
                associatesList.appendChild(associateItem);
            });
            
            // Also update the reassign modal dropdown
            reassignAssociateInput.innerHTML = '<option value="">Select an associate</option>';
            appData.associates.forEach(associate => {
                const option = document.createElement('option');
                option.value = associate.id;
                option.textContent = associate.name;
                reassignAssociateInput.appendChild(option);
            });
        }
        
        // Render tasks for the selected associate
        function renderTasks() {
            todoList.innerHTML = '';
            ongoingList.innerHTML = '';
            doneList.innerHTML = '';
            
            if (!currentAssociateId) {
                todoList.innerHTML = '<div class="empty-state">Select an associate to view tasks</div>';
                return;
            }
            
            const associateTasks = appData.tasks
                .filter(task => task.associateId === currentAssociateId)
                .sort((a, b) => a.order - b.order);
            
            if (associateTasks.length === 0) {
                todoList.innerHTML = '<div class="empty-state">No tasks found for this associate</div>';
                return;
            }
            
            associateTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                const targetList = getTaskListElement(task.status);
                targetList.appendChild(taskElement);
            });
        }
        
        // Create a task card element
        function createTaskElement(task) {
            const taskElement = document.createElement('div');
            taskElement.className = 'task-card';
            taskElement.dataset.taskId = task.id;
            taskElement.draggable = true;
            
            // Add drag events
            taskElement.addEventListener('dragstart', () => {
                taskElement.classList.add('dragging');
            });
            
            taskElement.addEventListener('dragend', () => {
                taskElement.classList.remove('dragging');
            });
            
            // Format dates
            const createdDate = task.createdDate ? new Date(task.createdDate).toLocaleDateString() : '';
            const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : '';
            const completedDate = task.completedDate ? new Date(task.completedDate).toLocaleDateString() : '';
            
            // Format due date with status indicators
            let dueDateText = '';
            if (task.dueDate) {
                const due = new Date(task.dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                dueDateText = due.toLocaleDateString();
                
                if (due < today && task.status !== 'done') {
                    dueDateText += ' (Overdue)';
                } else if (due.toDateString() === today.toDateString()) {
                    dueDateText += ' (Today)';
                }
            }
            
            taskElement.innerHTML = `
                <div class="task-title">${task.title}</div>
                <div class="task-dates">
                    ${task.createdDate ? `<div class="task-date"><span class="task-date-label">Created:</span> ${createdDate}</div>` : ''}
                    ${task.dueDate ? `<div class="task-date ${getDueDateClass(task.dueDate, task.status)}"><span class="task-date-label">Due:</span> ${dueDateText}</div>` : ''}
                    ${task.completedDate ? `<div class="task-date"><span class="task-date-label">Completed:</span> ${completedDate}</div>` : ''}
                </div>
                ${task.notes ? `<div class="task-notes">${task.notes}</div>` : ''}
                <div class="task-actions">
                    <button class="edit-task info-btn">Edit</button>
                    <button class="reassign-task info-btn">Reassign</button>
                    <button class="delete-task danger-btn">Delete</button>
                </div>
            `;
            
            // Add event listeners to action buttons
            taskElement.querySelector('.edit-task').addEventListener('click', () => {
                editTask(task.id);
            });
            
            taskElement.querySelector('.reassign-task').addEventListener('click', () => {
                showReassignModal(task.id);
            });
            
            taskElement.querySelector('.delete-task').addEventListener('click', () => {
                deleteTask(task.id);
            });
            
            return taskElement;
        }
        
        // Show reassign modal
        function showReassignModal(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            reassignTaskIdInput.value = taskId;
            reassignAssociateInput.value = '';
            reassignModal.style.display = 'flex';
        }
        
        // Reassign a task to another associate
        function reassignTask() {
            const taskId = reassignTaskIdInput.value;
            const newAssociateId = reassignAssociateInput.value;
            
            if (!taskId || !newAssociateId) return;
            
            const task = appData.tasks.find(t => t.id === taskId);
            if (task) {
                task.associateId = newAssociateId;
                saveData();
                
                // If we're currently viewing the old associate's tasks, update the display
                if (currentAssociateId && currentAssociateId !== newAssociateId) {
                    renderTasks();
                }
                
                // Update the sidebar counts
                renderAssociates();
                
                reassignModal.style.display = 'none';
            }
        }
        
        // Get CSS class for due date based on status
        function getDueDateClass(dueDate, status) {
            if (status === 'done') return '';
            
            const due = new Date(dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (due < today) return 'overdue';
            if (due.toDateString() === today.toDateString()) return 'today';
            return '';
        }
        
        // Get the DOM element for a task status
        function getTaskListElement(status) {
            switch (status) {
                case 'todo': return todoList;
                case 'ongoing': return ongoingList;
                case 'done': return doneList;
                default: return todoList;
            }
        }
        
        // Update UI based on current state
        function updateUI() {
            const hasAssociateSelected = !!currentAssociateId;
            
            // Enable/disable buttons based on selection
            editAssociateBtn.disabled = !hasAssociateSelected;
            deleteAssociateBtn.disabled = !hasAssociateSelected;
            addTaskBtn.disabled = !hasAssociateSelected;
        }
        
        // Save a task (add or edit)
        function saveTask() {
            const today = new Date().toISOString().split('T')[0];
            const taskData = {
                id: isEditingTask ? taskIdInput.value : generateId(),
                associateId: currentAssociateId,
                title: taskTitleInput.value,
                dueDate: taskDueDateInput.value,
                status: taskStatusInput.value,
                notes: taskNotesInput.value,
                createdDate: isEditingTask ? appData.tasks.find(t => t.id === taskIdInput.value)?.createdDate || today : today,
                completedDate: taskStatusInput.value === 'done' ? today : 
                              (isEditingTask ? appData.tasks.find(t => t.id === taskIdInput.value)?.completedDate || '' : ''),
                order: 0 // Will be updated when rendered
            };
            
            if (isEditingTask) {
                // Update existing task
                const index = appData.tasks.findIndex(t => t.id === taskData.id);
                if (index !== -1) {
                    // Preserve the existing order
                    taskData.order = appData.tasks[index].order;
                    appData.tasks[index] = taskData;
                }
            } else {
                // Add new task
                appData.tasks.push(taskData);
            }
            
            saveData();
            renderAssociates();
            renderTasks();
            taskModal.style.display = 'none';
        }
        
        // Edit a task
        function editTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            isEditingTask = true;
            taskModalTitle.textContent = 'Edit Task';
            taskIdInput.value = task.id;
            taskTitleInput.value = task.title;
            taskDueDateInput.value = task.dueDate || '';
            taskStatusInput.value = task.status;
            taskNotesInput.value = task.notes || '';
            
            taskModal.style.display = 'flex';
        }
        
        // Delete a task
        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                appData.tasks = appData.tasks.filter(t => t.id !== taskId);
                saveData();
                renderAssociates();
                renderTasks();
            }
        }
        
        // Save an associate (add or edit)
        function saveAssociate() {
            const associateData = {
                id: isEditingAssociate ? associateIdInput.value : generateId(),
                name: associateNameInput.value
            };
            
            if (isEditingAssociate) {
                // Update existing associate
                const index = appData.associates.findIndex(a => a.id === associateData.id);
                if (index !== -1) {
                    appData.associates[index] = associateData;
                }
            } else {
                // Add new associate
                appData.associates.push(associateData);
            }
            
            saveData();
            renderAssociates();
            associateModal.style.display = 'none';
            
            // Select the new/edited associate
            if (associateData.id) {
                currentAssociateId = associateData.id;
                renderAssociates();
                renderTasks();
                updateUI();
            }
        }
        
        // Export data to JSON file
        function exportData() {
            if (appData.associates.length === 0 && appData.tasks.length === 0) {
                alert('No data to export.');
                return;
            }
            
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `task-tracker-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // Export completed tasks to CSV
        function exportDoneTasks() {
            const doneTasks = appData.tasks.filter(task => task.status === 'done');
            
            if (doneTasks.length === 0) {
                alert('No completed tasks to export.');
                return;
            }
            
            // Get associate names for the tasks
            const tasksWithAssociates = doneTasks.map(task => {
                const associate = appData.associates.find(a => a.id === task.associateId);
                return {
                    ...task,
                    associateName: associate ? associate.name : 'Unknown'
                };
            });
            
            // Create CSV content
            const headers = ['Associate', 'Task Title', 'Created Date', 'Due Date', 'Completed Date', 'Notes'];
            const rows = tasksWithAssociates.map(task => {
                return [
                    `"${task.associateName.replace(/"/g, '""')}"`,
                    `"${task.title.replace(/"/g, '""')}"`,
                    `"${task.createdDate || ''}"`,
                    `"${task.dueDate || ''}"`,
                    `"${task.completedDate || ''}"`,
                    `"${(task.notes || '').replace(/"/g, '""')}"`
                ].join(',');
            });
            
            const csvContent = [
                headers.join(','),
                ...rows
            ].join('\n');
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `completed-tasks-${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Import data from JSON file
        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Basic validation
                    if (!importedData || !Array.isArray(importedData.associates) || !Array.isArray(importedData.tasks)) {
                        throw new Error('Invalid data format');
                    }
                    
                    if (confirm('This will replace your current data. Continue?')) {
                        appData = importedData;
                        
                        // Ensure all tasks have createdDate
                        const today = new Date().toISOString().split('T')[0];
                        appData.tasks = appData.tasks.map(task => {
                            if (!task.createdDate) {
                                task.createdDate = today;
                            }
                            return task;
                        });
                        
                        saveData();
                        currentAssociateId = null;
                        renderAssociates();
                        renderTasks();
                        updateUI();
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            e.target.value = '';
        }
        
        // Generate a random ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // Initialize the app
        init();
    </script>
</body>
</html>
